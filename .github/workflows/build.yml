name: Docker Build

on:
  push:
    branches:
      - main  # Trigger the workflow when pushing to the main branch
  pull_request:
    branches:
      - main  # Also trigger on pull requests to the main branch

jobs:
  build:
    runs-on: ubuntu-latest  # You can use macos-latest or windows-latest if necessary

    steps:
      # Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up Rust environment
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      # Install dependencies (Make sure make is installed)
      - name: Install Make
        run: sudo apt-get install -y make

      # Set up Docker Buildx (optional, but recommended for multi-platform support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Create .env file with dynamic values
      - name: Create .env file
        run: |
          echo "REFRESH_TOKEN_PRIVATE_KEY=" > .env
          echo "REFRESH_TOKEN_PUBLIC_KEY=" >> .env
          echo "ACCESS_TOKEN_PRIVATE_KEY=" >> .env
          echo "ACCESS_TOKEN_PUBLIC_KEY=" >> .env
          
          echo "DB_HOST=\"127.0.0.1\"" >> .env
          echo "DB_PORT=\"5432\"" >> .env
          echo "DB_USER=\"user_$(date +%s)\"" >> .env
          echo "DB_PASS=\"pass_$(date +%s)\"" >> .env
          echo "DB_NAME=\"development_db_$(date +%s)\"" >> .env
          echo "DB_NAMESPACE=\"gymconnect\"" >> .env

          echo "REDIS_HOST=\"redis-$(shuf -i 10000-99999 -n 1).ec2.redns.redis-cloud.com\"" >> .env
          echo "REDIS_USERNAME=\"default\"" >> .env
          echo "REDIS_PASSWORD=\"password_$(date +%s)\"" >> .env
          echo "REDIS_PORT=\"6379\"" >> .env

          echo "MAILJET_API_KEY=\"api_key_$(shuf -i 1000000000000000-9999999999999999 -n 1)\"" >> .env
          echo "HOST_NAME=\"http://localhost:3000/api/v1/verify/\"" >> .env

          echo "GCP_CREDENTIALS_PATH=\"/path/to/gcp/credentials/$(date +%s)-gcp.json\"" >> .env
          echo "RUNNING_ENVIRONMENT=\"development\"" >> .env
          echo "STORAGE_BUCKET=\"bucket_$(shuf -i 1000-9999 -n 1)\"" >> .env
          echo "GOOGLE_STORAGE_API_HOST=\"https://storage.googleapis.com\"" >> .env

      # Run the Makefile to build the Docker image
      - name: Build Docker image using Makefile
        run: make build
